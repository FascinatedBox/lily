import (Interpreter,
        TestCase) "../t/testing", utf8

class TestPkgUTF8 < TestCase
{
    public define test_as_list
    {
        assert_equal(utf8.as_list(""), [])
        assert_equal(utf8.as_list("abc"), [97, 98, 99])
        assert_equal(utf8.as_list("cafÃ©"), [99, 97, 102, 233])
        assert_equal(utf8.as_list("ğŸ™‚ğŸ™"), [128578, 128577])
        assert_equal(utf8.as_list(" â€‹ "), [32, 8203, 32])
    }

    public define test_compare
    {
        assert_equal(utf8.compare("", ""), 0)
        assert_equal(utf8.compare("abc", ""), 1)
        assert_equal(utf8.compare("abc", "def"), -1)
        assert_equal(utf8.compare("ğŸ™‚", "ğŸ™‚"), 0)
        assert_equal(utf8.compare("ğŸ™", "ğŸ™‚"), -1)
        assert_equal(utf8.compare("ğŸ™‚ğŸ™", "ğŸ™ğŸ™‚"), 1)
        assert_equal(utf8.compare(" â€‹ ", " â€‹ "), 0)
        assert_equal(utf8.compare(" â€‹ ", "   "), 1)

        assert_equal(["ğŸ™‚ğŸ™", "ğŸ™‚ğŸ™‚", "ğŸ™ğŸ™‚", "ğŸ™ğŸ™"].sort(utf8.compare),
                ["ğŸ™ğŸ™", "ğŸ™ğŸ™‚", "ğŸ™‚ğŸ™", "ğŸ™‚ğŸ™‚"])
    }

    public define test_each_codepoint
    {
        for string in ["", "abc", "cafÃ©", "ğŸ™‚ğŸ™", " â€‹ "]: {
            var codepoints: List[Integer] = []
            utf8.each_codepoint(string, (|c| codepoints.push(c)))
            assert_equal(codepoints, utf8.as_list(string))
        }
    }

    public define test_each_codepoint_with_index
    {
        for string in ["", "abc", "cafÃ©", "ğŸ™‚ğŸ™", " â€‹ "]: {
            var codepoints_with_indices: List[Tuple[Integer, Integer]] = []

            utf8.each_codepoint_with_index(string,
                    (|c, i| codepoints_with_indices.push(<[c, i]>) ))

            assert_equal(codepoints_with_indices,
                    utf8.as_list(string).map_with_index(|c, i| <[c, i]>))
        }
    }

    public define test_encode
    {
        for string in ["", "abc", "cafÃ©", "ğŸ™‚ğŸ™", " <200b> "]: {
            assert_equal(utf8
                         .as_list(string)
                         .map(utf8.encode)
                         .map(Option.unwrap)
                         .join(), string)
        }

        assert_equal(utf8.encode(-1), None)
        assert_equal(utf8.encode(1114112), None)
    }

    public define test_encode_list
    {
        for string in ["", "abc", "cafÃ©", "ğŸ™‚ğŸ™", " <200b> "]: {
            assert_equal(string
                         |> utf8.as_list
                         |> utf8.encode_list
                         |> Option.unwrap, string)
        }

        assert_equal(utf8.encode_list(['A', 'B', 'C', -1]), None)
        assert_equal(utf8.encode_list([1114112, 'A', 'B', 'C']), None)
    }

    public define test_get
    {
        assert_equal(utf8.get("abc", 1), 98)
        assert_equal(utf8.get("cafÃ©", 3), 233)
        assert_equal(utf8.get("ğŸ™‚ğŸ™", -2), 128578)
        assert_equal(utf8.get(" â€‹ ", 1), 8203)

        assert_raises("IndexError: Index 0 is out of range.",
                (|| utf8.get("", 0) ))

        assert_raises("IndexError: Index 2 is out of range.",
                (|| utf8.get("ğŸ™‚ğŸ™", 2) ))

        assert_raises("IndexError: Index -3 is out of range.",
                (|| utf8.get("ğŸ™‚ğŸ™", -3) ))
    }

    public define test_length
    {
        assert_equal(utf8.length(""), 0)
        assert_equal(utf8.length("abc"), 3)
        assert_equal(utf8.length("cafÃ©"), 4)
        assert_equal(utf8.length("ğŸ™‚ğŸ™"), 2)
        assert_equal(utf8.length(" â€‹ "), 3)
    }

    public define test_slice
    {
        assert_equal(utf8.slice("abcdef", 1, 5), "bcde")
        assert_equal(utf8.slice("cafÃ©", 1, 4), "afÃ©")
        assert_equal(utf8.slice("ğŸ™‚ğŸ™", 0, 2), "ğŸ™‚ğŸ™")
        assert_equal(utf8.slice(" â€‹ ", 1, 2), "â€‹")

        assert_equal(utf8.slice("abcdef", 2, -2), "cd")
        assert_equal(utf8.slice("ğŸ™‚ğŸ™ğŸ™‚ğŸ™", -3, -1), "ğŸ™ğŸ™‚")
        assert_equal(utf8.slice(" â€‹ ", -2, -1), "â€‹")

        assert_equal(utf8.slice("abcdef", 3), "def")
        assert_equal(utf8.slice("cafÃ©", -3), "afÃ©")
        assert_equal(utf8.slice("ğŸ™‚ğŸ™", 1), "ğŸ™")

        assert_equal(utf8.slice(""), "")
        assert_equal(utf8.slice("abcdef"), "abcdef")
        assert_equal(utf8.slice("cafÃ©"), "cafÃ©")
        assert_equal(utf8.slice("ğŸ™‚ğŸ™"), "ğŸ™‚ğŸ™")

        assert_equal(utf8.slice("cafÃ©", 4), "")
        assert_equal(utf8.slice("cafÃ©", -5), "")
        assert_equal(utf8.slice("cafÃ©", 0, 5), "")
        assert_equal(utf8.slice("cafÃ©", 2, 1), "")
        assert_equal(utf8.slice("cafÃ©", -2, 1), "")
        assert_equal(utf8.slice("cafÃ©", 1, 1), "")
        assert_equal(utf8.slice("cafÃ©", -3, -3), "")
    }
}
